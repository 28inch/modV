var modV=function(h){function H(a,b){b=b.toUpperCase();do if(a.nodeName===b)return a;while(a=a.parentNode);return!1}function M(){var a=document.createElement("select"),b=document.createElement("optgroup");b.label="Blend Modes";"normal multiply overlay darken lighten color-dodge color-burn hard-light soft-light difference exclusion hue saturation color luminosity".split(" ").forEach(function(a){var c=document.createElement("option");c.value=a;c.textContent=a.replace("-"," ");c.textContent=c.textContent.charAt(0).toUpperCase()+ c.textContent.slice(1);b.appendChild(c)});var c=document.createElement("optgroup");c.label="Composite Modes";"clear copy destination source-over destination-over source-in destination-in source-out destination-out source-atop destination-atop xor lighter".split(" ").forEach(function(a){var b=document.createElement("option");b.value=a;b.textContent=a.replace("-"," ");b.textContent=b.textContent.charAt(0).toUpperCase()+b.textContent.slice(1);c.appendChild(b)});a.appendChild(b);a.appendChild(c);return a} function N(a,b){switch(a){case "float":b=parseFloat(b);break;case "int":b=parseInt(b)}return b}function I(a,b){if(a.origin===f.options.controlDomain||b){if("variable"===a.data.type){var c=N(a.data.varType,a.data.payload);e[a.data.modName][a.data.name]=c;e[a.data.modName].info.controls[a.data.index].currValue=c;b&&(c=a.data.payload,"append"in a.data&&(c=c.replace(a.data.append,"")),g.postMessage({type:"ui",varType:a.data.varType,modName:a.data.modName,name:a.data.name,payload:c,index:a.data.index}, f.options.controlDomain));console.log(a.data.modName,a.data.name,e[a.data.modName].info.controls[a.data.index].currValue)}"image"===a.data.type&&(e[a.data.modName][a.data.name].src=a.data.payload);"video"===a.data.type&&(e[a.data.modName][a.data.name].src=a.data.payload,e[a.data.modName][a.data.name].load(),e[a.data.modName][a.data.name].play());"multiimage"===a.data.type&&(a.data.wipe&&(e[a.data.modName][a.data.name].length=0),a.data.payload.forEach(function(b){var l=new Image;l.src=b;e[a.data.modName][a.data.name].push(l)})); "modBlend"===a.data.type&&(e[a.data.modName].info.blend=a.data.payload,b&&(g.postMessage({type:"ui-blend",modName:a.data.modName,payload:a.data.payload},f.options.controlDomain),console.log(a.data)));"modOpacity"===a.data.type&&(e[a.data.modName].info.alpha=a.data.payload,b&&(g.postMessage({type:"ui-opacity",modName:a.data.modName,payload:a.data.payload},f.options.controlDomain),console.log(a.data)));if("setOrderUp"===a.data.type){var d=-1;m.forEach(function(b,l){a.data.modName===b&&(d=l)});0<d&& (--d,f.setModOrder(a.data.modName,d))}"setOrderFromElements"===a.data.type&&(d=-1,m.forEach(function(b,l){a.data.y===b&&(d=l)}),0<d&&f.setModOrder(a.data.x,d));"check"===a.data.type&&(e[a.data.modName].info.disabled=a.data.payload?!1:!0,b&&g.postMessage({type:"ui-enabled",modName:a.data.modName,payload:a.data.payload},f.options.controlDomain));if("global"===a.data.type&&("clearing"===a.data.name&&(f.clearing=a.data.payload?!0:!1),"mute"===a.data.name&&(x.gain.value=a.data.payload?0:1),"savepreset"=== a.data.name)){var c={},k;for(k in e)c[k]=e[k].info;f.presets[a.data.payload.name]=c;console.info("Wrote preset with name:",a.data.payload.name)}}}(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var g= (new Date).getTime(),l=Math.max(0,16-(g-a)),f=window.setTimeout(function(){b(g+l)},l);a=g+l;return f});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();Object.size=function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b};Array.contains=function(a,b){return-1<b.indexOf(a)};navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia;var m=[],e={},f=this, A=document.createElement("video"),y=!1;this.presets={};var B,E=[],t,z,C,x,F=!1;this.meyda;this.meydaFeatures=[];this.addMeydaFeature=function(a){if(Array.contains(a,f.meydaFeatures))return!1;f.meydaFeatures.push(a);return!0};"function"===typeof window.Meyda&&(y=!0,console.info("meyda detected, expanded audio analysis available.","Use this.meyda to access from console."));A.autoplay=!0;A.muted=!0;this.options="undefined"!==typeof h?h:{};this.options.controlDomain||(this.options.controlDomain=location.protocol+ "//"+location.host);window.addEventListener("message",I,!1);var g=window.open("","_blank","width=480.96, height="+screen.height+", location=yes, menubar=yes, left="+screen.width/100*66.6);g.window.presets={};h=function(){return"You sure about that, you drunken mess?"};if(this.options.previewWindow){var D=window.open("","_blank","width=640, height=480, location=no, menubar=no, left=0"),v=document.createElement("canvas"),O=v.getContext("2d");D.document.body.style.margin="0px";v.width=640;v.height=480; D.onbeforeunload=h;D.document.body.appendChild(v)}g.onbeforeunload=h;window.onbeforeunload=h;var u=new XMLHttpRequest;u.open("GET","control-stylesheet.css",!1);u.onreadystatechange=function(){if(4===u.readyState&&(200===u.status||0===u.status)){var a=u.responseText.split("}"),b=document.createElement("style");b.appendChild(document.createTextNode(""));b=g.window.document.head.appendChild(b);a.forEach(function(c,d){if(d===a.length-1)return!1;b.sheet.insertRule(c+"}",0)})}};u.send(null);h=document.createElement("script"); h.src="./slip/slip.js";h.onload=function(){g.window.document.body.addEventListener("slip:beforewait",function(a){-1<a.target.className.indexOf("instant")&&a.preventDefault()},!1);g.window.document.body.addEventListener("slip:reorder",function(a){a.target.parentNode.insertBefore(a.target,a.detail.insertBefore);return!1},!1);g.window.initSlip=function(){new Slip(g.window.document.body)};g.window.initSlip()};g.window.document.head.appendChild(h);g.window.receiveMessage=function(a){if(a.origin===f.options.controlDomain){if("ui"=== a.data.type){var b=a.data.modName+"-"+a.data.name,c=g.window.document.getElementById(b);g.window.console.log(b,c,a.data.payload);"checkbox"===a.data.varType?c.checked=a.data.payload:c.value=a.data.payload}if("ui-blend"===a.data.type)for(b=a.data.modName+"-blend",c=g.window.document.getElementById(b),g.window.console.log(b,c,a.data.payload),b=0;b<c.options.length;b++)if(c.options[b].value===a.data.payload){c.selectedIndex=b;break}"ui-enabled"===a.data.type&&(b=a.data.modName+"-enabled",c=g.window.document.getElementById(b), g.window.console.log(b,c,a.data.payload),c.checked=a.data.payload);"ui-opacity"===a.data.type&&(b=a.data.modName+"-opacity",c=g.window.document.getElementById(b),g.window.console.log(b,c,a.data.payload),c.value=a.data.payload)}};g.window.addEventListener("message",g.window.receiveMessage,!1);window.addEventListener("beforeunload",function(){try{g.close(),D.close()}catch(a){}},!1);var G=!1,J;if(this.options.remote)try{var r=new WebSocket(this.options.remote);r.onerror=function(){G=!0;console.error('Sorry, the web socket at "%s" is un-available', url)};r.onmessage=function(a){a=JSON.parse(a.data);console.group("WebSocket logs");console.log("Message received:",a);if(!("type"in a))return!1;var b=a.payload;switch(a.type){case "hello":console.log(b.name,"says hi. Server version number:",b.version);G=!0;J=b.id;r.send(JSON.stringify({type:"declare",payload:{type:"client",id:J}}));break;case "registerCB":console.log("Server says",b.name,"was registered with order number",b.index);e[b.name].info.name===b.name?e[b.name].info.order===b.index?console.log("True!"): console.log("False!"):console.log("False!");break;default:I({data:a},!0)}console.groupEnd()};r.onclose=function(){console.group("WebSocket logs");console.log("Connection closed");console.groupEnd()};r.onopen=function(){console.group("WebSocket logs");console.log("Successful initial connection to",f.options.remote);console.groupEnd()}}catch(P){console.error("There was an un-identified Web Socket error")}navigator.getUserMedia({audio:{optional:[{googNoiseSuppression:!1},{googEchoCancellation:!1},{googEchoCancellation2:!1}, {googAutoGainControl:!1},{googNoiseSuppression2:!1},{googHighpassFilter:!1},{googTypingNoiseDetection:!1}]},video:{optional:[{googNoiseSuppression:!1},{googEchoCancellation:!1},{googEchoCancellation2:!1},{googAutoGainControl:!1},{googNoiseSuppression2:!1},{googHighpassFilter:!1},{googTypingNoiseDetection:!1}]}},function(a){A.src=window.webkitURL.createObjectURL(a);t=new window.AudioContext;z=t.createAnalyser();B=t.createScriptProcessor(1024,1,1);B.onaudioprocess=function(){z.getByteTimeDomainData(E)}; x=t.createGain();x.gain.value=0;C=t.createMediaStreamSource(a);C.connect(x);x.connect(t.destination);y&&(f.meyda=new Meyda(t,C,512));C.connect(z);z.connect(B);B.connect(t.destination);E=FFTData=new Uint8Array(z.frequencyBinCount);F=!0},function(){console.log("Error setting up WebAudio - please make sure you've allowed modV access.")});this.canvas=void 0;this.clearing=!0;this.setCanvas=function(a){if("CANVAS"!==a.nodeName)return console.error("modV: setCanvas was not supplied with a CANVAS element."), !1;this.canvas=a;this.context=a.getContext("2d");window.addEventListener("resize",function(){f.canvas.width=window.innerWidth;f.canvas.height=window.innerHeight;for(var a in e)"function"===typeof e[a].init&&e[a].init(f.canvas,f.context)},!1);return!0};this.setDimensions=function(a,b){if("undefined"===typeof a&&"undefined"===typeof b)console.error("modV: setDimensions was not supplied anything!");else{if("number"!==typeof a){console.error("modV: setDimensions was not supplied with a number type."); return}if("number"!==typeof b){console.error("modV: setDimensions was not supplied with a number type.");return}}"undefined"===typeof a&&"undefined"!==typeof b?this.canvas.width=this.canvas.height=b:"undefined"!==typeof a&&"undefined"===typeof b?this.canvas.width=this.canvas.height=a:(this.canvas.width=a,this.canvas.height=b)};h=document.createElement("fieldset");var p=document.createElement("legend");p.textContent="Global";h.appendChild(p);p=document.createElement("label");p.textContent="Clearing "; var q=document.createElement("input");q.type="checkbox";q.checked=!1;q.addEventListener("change",function(){g.window.opener.postMessage({type:"global",name:"clearing",payload:this.checked},f.options.controlDomain)});p.appendChild(q);h.appendChild(p);h.appendChild(document.createElement("br"));p=document.createElement("label");p.textContent="Mute ";q=document.createElement("input");q.type="checkbox";q.checked=!0;q.addEventListener("change",function(){g.window.opener.postMessage({type:"global",name:"mute", payload:this.checked},f.options.controlDomain)});p.appendChild(q);h.appendChild(p);h.appendChild(document.createElement("br"));var p=document.createElement("div"),w=document.createElement("input");w.type="text";w.placeholder="Preset Name";q=document.createElement("button");q.textContent="Save new Preset";q.addEventListener("click",function(){var a=!1,b=!1;w.value in f.presets&&(b=!0,a=confirm('A preset with the name "'+w.value+'"already exists!\nIs it okay to overwrite?'));(!b||b&&a)&&g.window.opener.postMessage({type:"global", name:"savepreset",payload:{name:w.value}},f.options.controlDomain)});p.appendChild(w);p.appendChild(q);h.appendChild(p);g.document.body.appendChild(h);this.registerMod=function(a){a=new a;"function"===typeof a.init&&a.init(this.canvas,this.context);"blend"in a.info||(a.info.blend="normal");"alpha"in a.info||(a.info.alpha=1);a.info.disabled=!0;y&&"meyda"in a.info?a.info.meyda.forEach(this.addMeydaFeature):!y&&"meyda"in a.info&&console.warn("Whilst registering the module '"+a.info.name+"', modV detected it requests Meyda which has not been included on the page. You may encounter problems using this module without Meyda."); var b=document.createElement("fieldset"),c=null;b.addEventListener("drop",function(a){a.preventDefault();var b=H(a.target,"fieldset");b.style.backgroundColor="white";console.log(b);var c=b.dataset.name;a=a.dataTransfer.getData("text");var d=g.document.querySelector('fieldset[data-name="'+a+'"]');d.parentNode.insertBefore(d,b);g.window.opener.postMessage({type:"setOrderFromElements",x:a,y:c},f.options.controlDomain);console.log(d)},!1);b.addEventListener("dragover",function(a){a.preventDefault();c= H(a.target,"fieldset");try{c.style.backgroundColor="green"}catch(b){}},!1);b.addEventListener("dragleave",function(a){a.preventDefault();c.style.backgroundColor="white"},!1);b.dataset.name=a.info.name;b.style.position="relative";var d=document.createElement("legend");d.textContent=a.info.name;d.style.fontSize="20px";b.appendChild(d);d=document.createElement("label");d.textContent="Enabled ";var k=document.createElement("input");k.type="checkbox";k.checked=!1;k.addEventListener("change",function(){g.window.opener.postMessage({type:"check", modName:a.info.name,payload:this.checked},f.options.controlDomain);f.options.remote&&r.send(JSON.stringify({type:"ui-enabled",modName:a.info.name,payload:this.checked}))});k.id=a.info.name+"-enabled";d.appendChild(k);b.appendChild(d);b.appendChild(document.createElement("br"));d=document.createElement("button");d.textContent="UP";d.addEventListener("click",function(){g.window.opener.postMessage({type:"setOrderUp",modName:a.info.name},f.options.controlDomain)});b.appendChild(d);b.appendChild(document.createElement("br")); k=document.createElement("input");k.type="range";d=document.createElement("label");d.textContent="Opacity ";k.min=0;k.max=1;k.step=.01;k.value=a.info.alpha;k.addEventListener("input",function(){g.window.opener.postMessage({type:"modOpacity",modName:a.info.name,payload:this.value},f.options.controlDomain);f.options.remote&&r.send(JSON.stringify({type:"ui-opacity",modName:a.info.name,payload:this.value}))});k.id=a.info.name+"-opacity";d.appendChild(k);b.appendChild(d);b.appendChild(document.createElement("br")); k=M();d=document.createElement("label");d.textContent="Blending ";k.addEventListener("change",function(){g.window.opener.postMessage({type:"modBlend",modName:a.info.name,payload:this.value},f.options.controlDomain);f.options.remote&&r.send(JSON.stringify({type:"ui-blend",modName:a.info.name,payload:this.value}))});k.id=a.info.name+"-blend";d.appendChild(k);b.appendChild(d);b.appendChild(document.createElement("br"));d=document.createElement("div");d.classList.add("mover");d.classList.add("instant"); d.style.width="50px";d.style.height="50px";d.style.borderRadius="50%";d.style.backgroundColor="red";d.style.textAlign="center";d.style.fontSize="44px";d.style.color="white";d.style.position="absolute";d.style.right="-8px";d.style.top="-8px";d.draggable=!0;d.addEventListener("dragstart",function(a){a.dataTransfer.setData("text",a.target.parentNode.dataset.name)},!1);d.addEventListener("dragend",function(a){},!1);b.appendChild(d);"controls"in a.info&&a.info.controls.forEach(function(c,d){var e=c.variable, k=document.createElement("label");k.textContent=c.label+" ";k.oncontextmenu=function(a){console.log(a);var b=document.createElement("div");b.classList.add("menu");b.style.top=a.clientY+a.offsetY+"px";b.style.left=a.clientX+a.offsetX+"px";g.window.document.body.appendChild(b);return!1};b.appendChild(document.createElement("hr"));if("video"===c.type){var h=new Image;h.src=a[e].src;b.addEventListener("dragover",function(a){a.preventDefault();this.classList.add("dragover")});b.addEventListener("dragend", function(a){a.preventDefault();this.classList.remove("dragover")});b.addEventListener("drop",function(b){b.preventDefault();this.classList.remove("dragover");(b=b.dataTransfer.files[0])&&b.type.match(/video.*/)&&(b=window.URL.createObjectURL(b),g.window.opener.postMessage({type:"video",modName:a.info.name,name:e,payload:b,index:d},f.options.controlDomain),a[e].play())});k.appendChild(h)}else if("image"===c.type)h=new Image,h.src=a[e].src,b.addEventListener("dragover",function(a){a.preventDefault(); this.classList.add("dragover")}),b.addEventListener("dragend",function(a){a.preventDefault();this.classList.remove("dragover")}),b.addEventListener("drop",function(b){b.preventDefault();this.classList.remove("dragover");(b=b.dataTransfer.files[0])&&b.type.match(/image.*/)&&(b=window.URL.createObjectURL(b),g.window.opener.postMessage({type:"image",modName:a.info.name,name:e,payload:b,index:d},f.options.controlDomain),h.src=b)}),k.appendChild(h);else if("multiimage"===c.type)h=new Image,b.addEventListener("dragover", function(a){a.preventDefault();this.classList.add("dragover")}),b.addEventListener("dragend",function(a){a.preventDefault();this.classList.remove("dragover")}),b.addEventListener("drop",function(b){b.preventDefault();var c=b.altKey;this.classList.remove("dragover");b=b.dataTransfer.files;for(var k=[],m=0,l;l=b[m];m++)l&&l.type.match(/image.*/)&&(l=window.URL.createObjectURL(l),h.src=l,k.push(l));g.window.opener.postMessage({type:"multiimage",modName:a.info.name,name:e,payload:k,wipe:c,index:d},f.options.controlDomain)}), k.appendChild(h);else{if("checkbox"===c.type){var m="checkbox",n=document.createElement("input");n.type=m;n.id=a.info.name+"-"+e;"checked"in c&&(n.checked=c.checked);n.addEventListener("change",function(){g.window.opener.postMessage({type:"variable",varType:m,modName:a.info.name,name:e,payload:n.checked,index:d},f.options.controlDomain)})}else m=c.type,n=document.createElement("input"),n.type=m,n.id=a.info.name+"-"+e,"min"in c&&(n.min=c.min),"max"in c&&(n.max=c.max),"step"in c&&(n.step=c.step),"varType"in c||(n.varType="string"),n.value="append"in c?a[e].replace(c.append,""):a[e],a.info.controls[d].currValue=a[e],console.log("cv",a.info.controls[d].currValue),n.addEventListener("input",function(){if("append"in c){var b=n.value+c.append;g.window.opener.postMessage({type:"variable",varType:c.varType,modName:a.info.name,name:e,payload:b,index:d,append:c.append},f.options.controlDomain);f.options.remote&&r.send(JSON.stringify({type:"ui",varType:c.varType,modName:a.info.name,name:e,payload:b,index:d,append:c.append}))}else g.window.opener.postMessage({type:"variable", varType:c.varType,modName:a.info.name,name:e,payload:n.value,index:d},f.options.controlDomain),f.options.remote&&r.send(JSON.stringify({type:"ui",varType:c.varType,modName:a.info.name,name:e,payload:n.value,index:d}))});k.appendChild(n)}b.appendChild(k);b.appendChild(document.createElement("br"))});g.document.body.appendChild(b);d=e[a.info.name]=a;this.setModOrder(a.info.name,Object.size(e));if(this.options.remote)try{r.send({type:"register",payload:a.info})}catch(h){}return d};this.setModOrder=function(a, b){if("undefined"===m[b])m[b]=a;else{var c=-1;m.forEach(function(b,d){a===b&&(c=d)});-1<c&&m.splice(c,1);m.splice(b,0,a);m.forEach(function(a,b){e[a].info.order=b;g.document.querySelector('fieldset[data-name="'+a+'"]').getElementsByClassName("mover")[0].textContent=b})}var d=g.document.body,f=d.querySelectorAll("fieldset[data-name]"),h=[],l;for(l in f)1===f[l].nodeType&&h.push(f[l]);h.sort(function(a,b){return e[a.dataset.name].info.order-e[b.dataset.name].info.order});for(l=0;l<h.length;++l)d.appendChild(h[l]); return m};this.drawFrame=function(a){if(F){this.clearing&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(var b=0;b<m.length;b++)"object"!==typeof e[m[b]]||e[m[b]].info.disabled||0===e[m[b]].info.alpha||(this.context.save(),this.context.globalAlpha=e[m[b]].info.alpha,"normal"!==e[m[b]].info.blend&&(this.context.globalCompositeOperation=e[m[b]].info.blend),e[m[b]].draw(this.canvas,this.context,E,A,a),this.context.restore());this.options.previewWindow&&O.drawImage(this.canvas,0, 0,v.width,v.height)}};var K,L=function(){requestAnimationFrame(L);if(y&&F)try{K=f.meyda.get(f.meydaFeatures)}catch(a){}f.drawFrame(K)};this.start=function(){if(f.options.remote&&!G)console.group("WebSocket Logs"),console.log("Websocket not connected yet, waiting for connection to start."),setTimeout(this.start,1E3),console.groupEnd();else{if(f.options.remote)for(var a in e)r.send(JSON.stringify({type:"register",payload:e[a].info}));requestAnimationFrame(L)}}};