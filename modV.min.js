var modV=function(e){function D(){var a=document.createElement("select"),b=document.createElement("optgroup");b.label="Blend Modes";"normal multiply overlay darken lighten color-dodge color-burn hard-light soft-light difference exclusion hue saturation color luminosity".split(" ").forEach(function(a){var d=document.createElement("option");d.value=a;d.textContent=a.replace("-"," ");d.textContent=d.textContent.charAt(0).toUpperCase()+d.textContent.slice(1);b.appendChild(d)});var f=document.createElement("optgroup"); f.label="Composite Modes";"clear copy destination source-over destination-over source-in destination-in source-out destination-out source-atop destination-atop xor lighter".split(" ").forEach(function(a){var b=document.createElement("option");b.value=a;b.textContent=a.replace("-"," ");b.textContent=b.textContent.charAt(0).toUpperCase()+b.textContent.slice(1);f.appendChild(b)});a.appendChild(b);a.appendChild(f);return a}function A(a,b){b=b.toUpperCase();do if(a.nodeName===b)return a;while(a=a.parentNode); return!1}(function(){for(var a=0,b=["ms","moz","webkit","o"],f=0;f<b.length&&!window.requestAnimationFrame;++f)window.requestAnimationFrame=window[b[f]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[f]+"CancelAnimationFrame"]||window[b[f]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,d){var w=(new Date).getTime(),x=Math.max(0,16-(w-a)),f=window.setTimeout(function(){b(w+x)},x);a=w+x;return f});window.cancelAnimationFrame||(window.cancelAnimationFrame= function(a){clearTimeout(a)})})();var h=[],g={},k=this,r=document.createElement("video");r.autoplay=!0;r.muted=!0;this.options="undefined"!==typeof e?e:{};if(window.io)io().on("connection",function(){alert("We have touchdown")});this.options.controlDomain||(this.options.controlDomain=location.protocol+"//"+location.host);window.addEventListener("message",function(a){if(a.origin===k.options.controlDomain){if("variable"==a.data.type){var b;switch(a.data.varType){case "float":b=parseFloat(a.data.payload); break;case "int":b=parseInt(a.data.payload);break;default:b=a.data.payload}g[a.data.modName][a.data.name]=b}"image"==a.data.type&&(g[a.data.modName][a.data.name].src=a.data.payload);"video"==a.data.type&&(g[a.data.modName][a.data.name].src=a.data.payload,g[a.data.modName][a.data.name].load(),g[a.data.modName][a.data.name].play());"multiimage"==a.data.type&&(a.data.wipe&&(g[a.data.modName][a.data.name].length=0),a.data.payload.forEach(function(b){var d=new Image;d.src=b;g[a.data.modName][a.data.name].push(d)})); "modBlend"==a.data.type&&(g[a.data.modName].info.blend=a.data.payload);"modOpacity"==a.data.type&&(g[a.data.modName].info.alpha=a.data.payload);if("setOrderUp"==a.data.type){var f=-1;h.forEach(function(b,d){a.data.modName==b&&(f=d)});0<f&&(--f,k.setModOrder(a.data.modName,f))}"setOrderFromElements"==a.data.type&&(f=-1,h.forEach(function(b,d){a.data.y==b&&(f=d)}),0<f&&k.setModOrder(a.data.x,f));"check"==a.data.type&&(g[a.data.modName].info.disabled=a.data.payload?!1:!0);"global"==a.data.type&&"clearing"== a.data.name&&(k.clearing=a.data.payload?!0:!1)}},!1);var l=window.open("","_blank","width=480.96, height="+screen.height+", location=yes, menubar=yes, left="+screen.width/100*66.6);e=function(a){return"You sure about that, you drunken mess?"};if(this.options.previewWindow){var s=window.open("","_blank","width=640, height=480, location=no, menubar=no, left=0"),n=document.createElement("canvas"),E=n.getContext("2d");s.document.body.style.margin="0px";n.width=640;n.height=480;s.onbeforeunload=e;s.document.body.appendChild(n)}l.onbeforeunload= e;window.onbeforeunload=e;e=document.createElement("link");e.type="text/css";e.rel="stylesheet";e.href="http://brkbrkbrk.com/dev/modV/control-stylesheet.css";l.document.getElementsByTagName("head")[0].appendChild(e);l.window.receiveMessage=function(a){};l.window.addEventListener("message",l.window.receiveMessage,!1);window.addEventListener("beforeunload",function(){try{l.close(),s.close()}catch(a){}},!1);var t=void 0,y=[],m=void 0,q=void 0,z=void 0,u=void 0,B=!1;navigator.getUserMedia=navigator.getUserMedia|| navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia;navigator.getUserMedia({audio:{optional:[{googNoiseSuppression:!1},{googEchoCancellation:!1},{googEchoCancellation2:!1},{googAutoGainControl:!1},{googNoiseSuppression2:!1},{googHighpassFilter:!1},{googTypingNoiseDetection:!1}]},video:{optional:[{googNoiseSuppression:!1},{googEchoCancellation:!1},{googEchoCancellation2:!1},{googAutoGainControl:!1},{googNoiseSuppression2:!1},{googHighpassFilter:!1}, {googTypingNoiseDetection:!1}]}},function(a){r.src=window.webkitURL.createObjectURL(a);m=new window.AudioContext;q=m.createAnalyser();t=m.createScriptProcessor(1024,1,1);t.onaudioprocess=function(){q.getByteTimeDomainData(y)};u=m.createGain();u.gain.value=0;z=m.createMediaStreamSource(a);z.connect(u);u.connect(m.destination);z.connect(q);q.connect(t);t.connect(m.destination);y=FFTData=new Uint8Array(q.frequencyBinCount);B=!0},function(){console.log("Error setting up WebAudio - please make sure you've allowed modV access.")}); this.canvas=void 0;this.clearing=!0;this.setCanvas=function(a){if("CANVAS"!=a.nodeName)return console.error("modV: setCanvas was not supplied with a CANVAS element."),!1;this.canvas=a;this.context=a.getContext("2d");window.addEventListener("resize",function(){k.canvas.width=window.innerWidth;k.canvas.height=window.innerHeight;for(mod in g)"function"==typeof mod.init&&mod.init(k.canvas,k.context)},!1);return!0};this.setDimensions=function(a,b){if("undefined"===typeof a&&"undefined"===typeof b)console.error("modV: setDimensions was not supplied anything!"); else{if("number"!==typeof a){console.error("modV: setDimensions was not supplied with a number type.");return}if("number"!==typeof b){console.error("modV: setDimensions was not supplied with a number type.");return}}"undefined"===typeof a&&"undefined"!==typeof b?this.canvas.width=this.canvas.height=b:"undefined"!==typeof a&&"undefined"===typeof b?this.canvas.width=this.canvas.height=a:(this.canvas.width=a,this.canvas.height=b)};e=document.createElement("fieldset");var p=document.createElement("legend"); p.textContent="Global";e.appendChild(p);p=document.createElement("label");p.textContent="Clearing ";var v=document.createElement("input");v.type="checkbox";v.checked=!1;v.addEventListener("change",function(){l.window.opener.postMessage({type:"global",name:"clearing",payload:this.checked},k.options.controlDomain)});p.appendChild(v);e.appendChild(p);e.appendChild(document.createElement("br"));l.document.body.appendChild(e);this.registerMod=function(a){"function"===typeof a.init&&a.init(this.canvas, this.context);"blend"in a.info||(a.info.blend="normal");"alpha"in a.info||(a.info.alpha=1);a.info.disabled=!0;var b=document.createElement("fieldset"),f=null;b.addEventListener("drop",function(a){a.preventDefault();var b=A(a.target,"fieldset");b.style.backgroundColor="white";console.log(b);var c=b.dataset.name;a=a.dataTransfer.getData("text");var d=l.document.querySelector('fieldset[data-name="'+a+'"]');d.parentNode.insertBefore(d,b);l.window.opener.postMessage({type:"setOrderFromElements",x:a,y:c}, k.options.controlDomain);console.log(d)},!1);b.addEventListener("dragover",function(a){a.preventDefault();f=A(a.target,"fieldset");try{f.style.backgroundColor="green"}catch(b){}},!1);b.addEventListener("dragleave",function(a){a.preventDefault();f.style.backgroundColor="white"},!1);b.dataset.name=a.info.name;b.style.position="relative";var c=document.createElement("legend");c.textContent=a.info.name;c.style.fontSize="20px";b.appendChild(c);c=document.createElement("label");c.textContent="Enabled "; document.createElement("br");var d=document.createElement("input");d.type="checkbox";d.checked=!1;d.addEventListener("change",function(){l.window.opener.postMessage({type:"check",modName:a.info.name,payload:this.checked},k.options.controlDomain)});c.appendChild(d);b.appendChild(c);b.appendChild(document.createElement("br"));c=document.createElement("button");c.textContent="UP";c.addEventListener("click",function(){l.window.opener.postMessage({type:"setOrderUp",modName:a.info.name},k.options.controlDomain)}); b.appendChild(c);b.appendChild(document.createElement("br"));d=document.createElement("input");d.type="range";c=document.createElement("label");c.textContent="Opacity ";d.min=0;d.max=1;d.step=.01;d.value=a.info.alpha;d.addEventListener("input",function(){l.window.opener.postMessage({type:"modOpacity",modName:a.info.name,payload:this.value},k.options.controlDomain)});c.appendChild(d);b.appendChild(c);b.appendChild(document.createElement("br"));d=D();c=document.createElement("label");c.textContent= "Blending ";d.addEventListener("change",function(){l.window.opener.postMessage({type:"modBlend",modName:a.info.name,payload:this.value},k.options.controlDomain)});c.appendChild(d);b.appendChild(c);b.appendChild(document.createElement("br"));c=document.createElement("div");c.classList.add("mover");c.style.width="50px";c.style.height="50px";c.style.borderRadius="50%";c.style.backgroundColor="red";c.style.textAlign="center";c.style.fontSize="44px";c.style.color="white";c.style.position="absolute";c.style.right= "-8px";c.style.top="-8px";c.draggable=!0;c.addEventListener("dragstart",function(a){a.dataTransfer.setData("text",a.target.parentNode.dataset.name)},!1);c.addEventListener("dragend",function(a){},!1);b.appendChild(c);"controls"in a.info&&a.info.controls.forEach(function(c){var d=c.variable,f=document.createElement("label");f.textContent=c.label+" ";b.appendChild(document.createElement("hr"));if("video"==c.type){var g=new Image;g.src=a[d].src;b.addEventListener("dragover",function(a){a.preventDefault(); this.classList.add("dragover")});b.addEventListener("dragend",function(a){a.preventDefault();this.classList.remove("dragover")});b.addEventListener("drop",function(b){b.preventDefault();this.classList.remove("dragover");(b=b.dataTransfer.files[0])&&b.type.match(/video.*/)&&(b=window.URL.createObjectURL(b),l.window.opener.postMessage({type:"video",modName:a.info.name,name:d,payload:b},k.options.controlDomain),a[d].play())});f.appendChild(g)}else if("image"==c.type)g=new Image,g.src=a[d].src,b.addEventListener("dragover", function(a){a.preventDefault();this.classList.add("dragover")}),b.addEventListener("dragend",function(a){a.preventDefault();this.classList.remove("dragover")}),b.addEventListener("drop",function(b){b.preventDefault();this.classList.remove("dragover");(b=b.dataTransfer.files[0])&&b.type.match(/image.*/)&&(b=window.URL.createObjectURL(b),l.window.opener.postMessage({type:"image",modName:a.info.name,name:d,payload:b},k.options.controlDomain),g.src=b)}),f.appendChild(g);else if("multiimage"==c.type)g= new Image,b.addEventListener("dragover",function(a){a.preventDefault();this.classList.add("dragover")}),b.addEventListener("dragend",function(a){a.preventDefault();this.classList.remove("dragover")}),b.addEventListener("drop",function(b){b.preventDefault();var c=b.altKey;this.classList.remove("dragover");b=b.dataTransfer.files;for(var f=[],e=0,h;h=b[e];e++)h&&h.type.match(/image.*/)&&(h=window.URL.createObjectURL(h),g.src=h,f.push(h));l.window.opener.postMessage({type:"multiimage",modName:a.info.name, name:d,payload:f,wipe:c},k.options.controlDomain)}),f.appendChild(g);else{if("checkbox"==c.type){var h="checkbox",e=document.createElement("input");e.type=h;"checked"in c&&(e.checked=c.checked);e.addEventListener("change",function(){l.window.opener.postMessage({type:"variable",varType:c.varType,modName:a.info.name,name:d,payload:e.checked},k.options.controlDomain)})}else h=c.type,e=document.createElement("input"),e.type=h,"min"in c&&(e.min=c.min),"max"in c&&(e.max=c.max),"step"in c&&(e.step=c.step), "varType"in c||(e.varType="string"),e.value=a[d],e.addEventListener("input",function(){"append"in c?l.window.opener.postMessage({type:"variable",varType:c.varType,modName:a.info.name,name:d,payload:e.value+c.append},k.options.controlDomain):l.window.opener.postMessage({type:"variable",varType:c.varType,modName:a.info.name,name:d,payload:e.value},k.options.controlDomain)});f.appendChild(e)}b.appendChild(f);b.appendChild(document.createElement("br"))});l.document.body.appendChild(b);return g[a.info.name]= a};this.setModOrder=function(a,b){if("undefined"==h[b])h[b]=a;else{var f=-1;h.forEach(function(b,c){a==b&&(f=c)});-1<f&&h.splice(f,1);h.splice(b,0,a);h.forEach(function(a,b){g[a].info.order=b;l.document.querySelector('fieldset[data-name="'+a+'"]').getElementsByClassName("mover")[0].textContent=b})}var c=l.document.body,d=c.querySelectorAll("fieldset[data-name]"),e=[],k;for(k in d)1==d[k].nodeType&&e.push(d[k]);e.sort(function(a,b){return g[a.dataset.name].info.order-g[b.dataset.name].info.order}); for(k=0;k<e.length;++k)c.appendChild(e[k]);return h};this.drawFrame=function(){if(B){console.time("Frame");this.clearing&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(var a=0;a<h.length;a++)"object"!=typeof g[h[a]]||g[h[a]].info.disabled||(this.context.save(),this.context.globalAlpha=g[h[a]].info.alpha,0!=g[h[a]].info.alpha&&("normal"!=g[h[a]].info.blend&&(this.context.globalCompositeOperation=g[h[a]].info.blend),g[h[a]].draw(this.canvas,this.context,y,r),this.context.restore())); this.options.previewWindow&&E.drawImage(this.canvas,0,0,n.width,n.height);console.time("Frame")}};var C=function(){requestAnimationFrame(C);k.drawFrame()};this.start=function(){requestAnimationFrame(C)}};